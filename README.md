# NITree

This is a proof of concept implementation for an algorithm that uses Named Identifiers (see [RFC 6920](https://www.rfc-editor.org/info/rfc6920) ) to hash a given key-value data structure (e.g. JSON) into a merkle tree like structure can be shared wihtout loosing full fine grained data access control. Publishing this Named Identifiers Tree (root), e.g. on a distributed ledger, can be used to notarize the full data structure. Furthermore, RFC 6920 specifies a URL too query for the data behind the NI. The data owner being querried can then authorise the querying party and reveal parts or all of the data in the NITree. By checking the hashes, the querying party can be sure to receive authentic data.


## Specs

### Input

For simplicity, we consider only the following data types:
- A String is an Object
- An unordered List of Objects is an Object
- An unordered Map of Strings to Objects is an Object

SOme special cases:
- The empty String/List/Map are all considered to be the same (emty) Object `""`
- A list of a single element is considered the same as the element itself.

The Input to the NITree generating Algorithm may be any Object.

### Root

A root of an NITree is a named identifier of the form "ni://n-authority/alg;val" where
- "alg" is the name of a hashing algorithm, e.g. "sha-256", see [RFC 6920](https://www.rfc-editor.org/info/rfc6920) for details. We will throughout use sha-256 for the specification, but of course any other cryptographic hash algorithm may be used in practise.
- "n-authority" is a domain name, e.g. "example.com". n-authority SHOULD be given for the main root in order to allow for data lookup. It MAY be omitted for sub-tree roots, in which case it is assumed to be the same as for the main root.
- "val" is the hash value

### Collisions

Different data inputs are to yield different main roots (up to collisions in the underlying hashing alg).

### Algorithm

#### Salted NIs for Strings

A string is converted into a root by first applying alg to the to generate a named identifier of the form
`ni://alg;val`. E.g. "Hello World!" yields 
```ni://sha-256;03ba204e50d126e4674c005e04d82e84c21366780af1f43bd54a37816b6ab340```

To prevent rainbow ttable/guessing attacks on the hash, the result SHOULD be salted and hashed again as follows:
A random salt is appended as a query parameter according to RFC 6920, e.g.
```ni://sha-256;03ba204e50d126e4674c005e04d82e84c21366780af1f43bd54a37816b6ab340?salt=NIPSI2XQLTRCNIUAYBNNWV6K5Q```. The length (entropy) of the salt can be adapted according to security needs. The resulting NI + salt is considered a string and hashed again into a new NI, e.g.
```ni://example.com/sha-256;319415cf8baadb98f52b775d496c391c4c02ba881e7e739a27f9afc15ac3b2f9```

If the original String already contains enough entropy, e.g. a large random number such as a serial, the salting step MAY be omitted.

The Empty String should always be salted.

The resulting NI is the NIRoot as well as the NITree of the string object.


#### NIs for Lists

For an unordered list, conmpute the NIRoots for all elements. The n-authority parts for the elements SHOULD be omitted. If an n-authority is given for one element, it MUST be given for all elements. The NIRoot of the list is then generated by 
- lexicographic sorting of the element NIRoots
- pairwise concatenating and hashing (computing the NIRoot for the concatenated string) to get a list with half as many entries
- repeat until there is only one NIRoot left
This standard merkle tree conctruction yields the NIRoot of the list. The NITree consists of the full merkle tree.

For Example `["Hello", "World"]` yields the NITree leaves
```
[
"ni://sha-256;6a045b452102c59d840ec097d59d9467e13a3f34f6494e539ffd32c1bb35f18", 
"ni://sha-256;a1db5c660d3d1f3f4f9361b9848694300929be94b74c84452a87420c59e5df9"
]
```
where salting has been omitted for simplicity in this example, but should be used for such simple values in practise. The root of this tree is
```ni://sha-256;3a8598032bf724139ad47f0ed685cd9e3004e0bd5ddc841e60521ee214e96a8d```.


#### NIs for Maps

The NITree of the map is generated by 
- Compute and concatenate the NIRoots of the keys and values in the map pairwise to get a list of strings
- Compute the NITree and NIRoot for this list as explained above

For example (again omitting hashing), the map
`{"A" : "Hello", "B" : "World"}`
is hashed to the list
```
[
"ni://sha-256;06f961b802bc46ee168555f066d28f4f0e9afdf3f88174c1ee6f9de004fc30a0ni://sha-256;6a045b452102c59d840ec097d59d9467e13a3f34f6494e539ffd32c1bb35f18",
"ni://sha-256;c0cde77fa8fef97d476c10aad3d2d54fcc2f336140d073651c2dcccf1e379fd6ni://sha-256;a1db5c660d3d1f3f4f9361b9848694300929be94b74c84452a87420c59e5df9"
]
```
with NIRoot
```ni://example.com/sha-256;377a9ef525b4913c5ea8509fae1b076a8e57a4164b228d44d3b0f5fe7204e747```
and tree leaves
```
[
"ni://sha-256;0cd00ff11ebe32325218a9cafadc8928eb55f4efb7832c918e7dcd84b964aa55",
"ni://sha-256;4379100bb9f57dbf836b53d2aadafc1ccb052a8b31ec23b6fcb6c9750388519d"
]
```

## References / Acknowledgment

Ideas for this algorithm are rooted in

- ![R. Tröger, S. Clanzett, R. J. Lehmann: Innovative Solution Approach for Controlling Access to Visibility Data in Open Food Supply Chains](http://dx.doi.org/10.18461/pfsd.2018.1817)
- M. Guenther, D. Woerner: ​ SupplyTree - A Federated Systems Approach to solve Supply Chain Traceability
- S. Schmittner: CIRC4Life - Deliverable 5.2 - Development Report and Documentation for Traceability Components and Tools - Data Access Model


## License

Copyright 2020 Sebastian Schmittner <sebastian@schmittner.pw>

<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />The algorithm description, documentation and other text documents in this work are licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>. You may use/adapt them as long as you share it under the same license and name "Sebastian Schmittner" as the original author.

<a href="https://www.gnu.org/licenses/gpl-3.0.html">
<img alt="GPLV3" style="border-width:0" src="http://www.gnu.org/graphics/gplv3-127x51.png" /><br />

All code published in this repository is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.
</a>

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
